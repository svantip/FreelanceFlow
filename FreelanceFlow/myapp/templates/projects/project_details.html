{% extends "base.html" %}
{% load static %}

{% block title %}{{ project.project_name }}{% endblock %}

{% block content %}
<div class="w-screen h-screen bg-gray-100">
  <!-- Top-left logo and Top-right navigation -->
  <div class="flex justify-between items-center p-8">
    <a href="{% url 'myapp:home' %}" class="flex items-center">
      <img src="{% static 'images/FF.svg' %}" alt="FreelanceFlow Logo" class="h-10 w-auto">
      <span class="ml-2 text-xl font-bold text-gray-800">FreelanceFlow</span>
    </a>
    <div>
      {% if user.is_authenticated %}
      <p class="inline text-gray-800">Hello, {{ user.username }}!</p>
      <form action="{% url 'myapp:logout' %}" method="POST" class="inline">
        {% csrf_token %}
        <button type="submit" class="ml-4 text-blue-500 hover:underline">Logout</button>
      </form>
      {% else %}
      <a href="{% url 'myapp:login' %}" class="text-blue-500 hover:underline">Login</a>
      <a href="{% url 'myapp:register' %}" class="ml-4 text-blue-500 hover:underline">Register</a>
      {% endif %}
    </div>
  </div>

  <!-- Main content -->
  <div class="p-8">
    {% if user.is_authenticated %}
    <div class="flex flex-row h-auto items-center space-x-2">
      <a href="{% url 'myapp:home' %}">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
          <path fill="none" d="M0 0h24v24H0V0z" opacity=".87"></path>
          <path
            d="M16.62 2.99c-.49-.49-1.28-.49-1.77 0L6.54 11.3c-.39.39-.39 1.02 0 1.41l8.31 8.31c.49.49 1.28.49 1.77 0s.49-1.28 0-1.77L9.38 12l7.25-7.25c.48-.48.48-1.28-.01-1.76z">
          </path>
        </svg>
      </a>
      <h1 class="text-xl font-bold">{{ project.project_name }}</h1>
    </div>

    <div class="flex flex-col lg:flex-row lg:space-x-8 mt-6">
      <!-- Left Column: Tasks -->
      <div class="flex-1">
        <h2 class="text-lg font-semibold mb-4">{{ project.project_name }}'s tasks</h2>
        {% if tasks %}
        <ul class="space-y-4">
          {% for task in tasks %}
          <li class="p-4 bg-white border rounded-3xl shadow flex justify-between items-center">
            <div>
              <h3 class="text-lg font-semibold">{{ task.task_name }}</h3>
              <p class="text-gray-600">{{ task.task_description }}</p>
              <p class="text-sm text-gray-500">Deadline: {{ task.task_deadline|date:"Y-m-d H:i" }}</p>
              <p class="text-sm text-gray-500">Status: {{ task.get_task_status_display }}</p>
            </div>
            <div class="flex items-center space-x-4">
              <!-- Checkbox za status -->
              <label class="flex items-center space-x-2">
                <input
                  type="checkbox"
                  data-task-id="{{ task.task_id }}"
                  {% if task.task_status == 'completed' %}checked{% endif %}
                  class="task-status-checkbox h-6 w-6 text-blue-600 border-gray-300 rounded focus:ring focus:ring-blue-300">
              </label>

              <!-- Gumb za brisanje -->
              <button
                class="delete-task-button bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-300">
                Delete
              </button>
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-gray-700">No tasks found for this project.</p>
        {% endif %}
      </div>

      <!-- Right Column: Users with Access -->
      <div class="lg:w-1/3">
        <h2 class="text-lg font-semibold lg:mb-4 mt-5 lg:mt-0">Users with Access</h2>
        <div class="space-y-4">
          {% for user in users %}
          <div class="p-2 bg-gray-100 rounded-lg shadow text-center">
            <p class="text-gray-700">{{ user.username }}</p>
          </div>
          {% empty %}
          <p class="text-gray-500">No other users have access to this project.</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="absolute bottom-0 right-0 m-5">
      <a href="{% url 'myapp:create_task' project.project_id %}" class="flex items-center bg-blue-500 text-white p-2 rounded-full shadow-lg hover:bg-blue-700" title="Create New Task">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 4a1 1 0 011 1v6h6a1 1 0 110 2h-6v6a1 1 0 11-2 0v-6H5a1 1 0 110-2h6V5a1 1 0 011-1z" />
        </svg>
      </a>
    </div>
    {% else %}
    <h1 class="text-xl font-bold">Please log in to access the project details.</h1>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const checkboxes = document.querySelectorAll(".task-status-checkbox");
  
    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener("change", async (e) => {
        const taskId = e.target.getAttribute("data-task-id");
        const newStatus = e.target.checked ? "completed" : "ongoing";
  
        try {
          const response = await fetch(`/update_task_status/${taskId}/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ status: newStatus }),
          });
  
          const data = await response.json();
          if (!response.ok) {
            console.error("Server error:", data.error);
            alert(data.error || "An error occurred.");
            e.target.checked = !e.target.checked; // Revert change on error
          } else {
            console.log("Success:", data.message);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("An unexpected error occurred.");
          e.target.checked = !e.target.checked; // Revert change on error
        }
      });
    });
       // Rukovanje brisanjem zadatka
       const deleteButtons = document.querySelectorAll(".delete-task-button");

       deleteButtons.forEach((button) => {
         button.addEventListener("click", async (e) => {
           const taskId = e.target.getAttribute("data-task-id");
   
           const confirmDelete = confirm("Are you sure you want to delete this task?");
           if (!confirmDelete) return;
   
           try {
             const response = await fetch(`/delete_task/${taskId}/`, {
               method: "POST",
               headers: {
                 "X-CSRFToken": "{{ csrf_token }}",
               },
             });
   
             const data = await response.json();
             if (response.ok) {
               alert(data.message);
               // Uklonite zadatak iz DOM-a
               e.target.closest("li").remove();
             } else {
               alert(data.error || "An error occurred.");
             }
           } catch (error) {
             console.error("Error:", error);
             alert("An unexpected error occurred.");
           }
         });
       });
  });
  
</script>
{% endblock %}
